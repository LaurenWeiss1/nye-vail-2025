<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>NYE Results</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .chart-bar {
      transition: all 0.3s ease;
    }
    .chart-bar:hover {
      transform: translateX(4px);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-blue-50 to-pink-50 min-h-screen">
  <div class="max-w-2xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-2">
        NYE Vail 2025
      </h1>
      <p class="text-gray-600">See who's going where</p>
    </div>

    <!-- Bar Selector -->
    <div class="bg-white rounded-3xl shadow-lg p-6 mb-6">
      <label class="block text-sm font-medium text-gray-700 mb-2">Select Bar</label>
      <select id="bar-select" class="w-full p-4 text-lg border-2 border-gray-200 rounded-xl bg-white focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition-all">
        <option value="">Choose a bar...</option>
      </select>
    </div>

    <!-- Chart Container -->
    <div id="chart"></div>

    <!-- Refresh Button -->
    <button onclick="loadData()" class="w-full mt-6 py-3 text-purple-600 font-medium hover:bg-white rounded-xl transition-all">
      â†» Refresh Data
    </button>
  </div>

  <script>
    // =============================================
    // PASTE YOUR PUBLISHED GOOGLE SHEET CSV URL HERE
    // =============================================
    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQGFIP5EqirEy7HKV9bYqz48bn_mY9TTdiOFEICnW552yVPC3_tdrQQzYsPuZPx5yIlyKj7jcA7kkBp/pub?output=csv'
    
    // =============================================
    // COLUMN NAMES - match your Google Form questions exactly
    // =============================================
    const COL_BAR = 'Which bar are you planning to attend for New Year\'s Eve in Vail?'
    const COL_GENDER = 'What is your gender?'
    const COL_AGE = 'What is your age?'
    // =============================================

    let data = []

    async function loadData() {
      try {
        console.log('Fetching data from:', SHEET_CSV_URL)
        const res = await fetch(SHEET_CSV_URL)
        const csv = await res.text()
        console.log('CSV data received:', csv.substring(0, 200))

        // Parse CSV
        const lines = csv.split('\n')
        const headers = parseCSVLine(lines[0])
        console.log('Headers:', headers)

        data = lines.slice(1).filter(line => line.trim()).map(line => {
          const values = parseCSVLine(line)
          const row = {}
          headers.forEach((h, i) => row[h] = values[i])
          return row
        })
        console.log('Parsed data rows:', data.length)

        // Populate dropdown
        const bars = [...new Set(data.map(r => r[COL_BAR]).filter(Boolean))]
        console.log('Unique bars found:', bars)
        const select = document.getElementById('bar-select')
        const currentVal = select.value
        select.innerHTML = '<option value="">Choose a bar...</option>' +
          bars.map(b => `<option value="${b}">${b}</option>`).join('')

        // Restore the previously selected value if it still exists
        if (currentVal && bars.includes(currentVal)) {
          select.value = currentVal
        }

        renderChart()
      } catch (error) {
        console.error('Error loading data:', error)
        alert('Error loading data. Check console for details.')
      }
    }

    function parseCSVLine(line) {
      const result = []
      let current = ''
      let inQuotes = false
      for (const char of line) {
        if (char === '"') inQuotes = !inQuotes
        else if (char === ',' && !inQuotes) { result.push(current.trim()); current = '' }
        else current += char
      }
      result.push(current.trim())
      return result
    }

    function getGenderColor(gender) {
      const g = gender.toLowerCase()
      if (g.includes('male') && !g.includes('female')) {
        return { solid: '#3b82f6', gradient: 'linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%)' }
      } else if (g.includes('female')) {
        return { solid: '#ec4899', gradient: 'linear-gradient(135deg, #f472b6 0%, #ec4899 100%)' }
      } else if (g.includes('nonbinary')) {
        return { solid: '#a855f7', gradient: 'linear-gradient(135deg, #c084fc 0%, #a855f7 100%)' }
      }
      return { solid: '#6b7280', gradient: 'linear-gradient(135deg, #9ca3af 0%, #6b7280 100%)' }
    }

    function getGenderIcon(gender) {
      const g = gender.toLowerCase()
      if (g.includes('male') && !g.includes('female')) {
        return 'â™‚'
      } else if (g.includes('female')) {
        return 'â™€'
      } else if (g.includes('nonbinary')) {
        return 'âš¥'
      }
      return 'ðŸ‘¤'
    }

    function renderChart() {
      const bar = document.getElementById('bar-select').value
      const container = document.getElementById('chart')

      if (!bar) {
        container.innerHTML = `
          <div class="bg-white rounded-3xl shadow-lg p-12 text-center">
            <div class="text-6xl mb-4">ðŸŽ‰</div>
            <p class="text-gray-400 text-lg">Select a bar to see who's going</p>
          </div>
        `
        return
      }

      const filtered = data.filter(r => r[COL_BAR] === bar)

      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="bg-white rounded-3xl shadow-lg p-12 text-center">
            <div class="text-6xl mb-4">ðŸ¤·</div>
            <p class="text-gray-400 text-lg">No responses yet for this bar</p>
          </div>
        `
        return
      }

      // Group by age, then by gender within each age
      const ageGroups = {}
      filtered.forEach(r => {
        const age = r[COL_AGE]
        const gender = r[COL_GENDER]
        if (!age || !gender) return

        if (!ageGroups[age]) {
          ageGroups[age] = { total: 0, genders: {} }
        }
        ageGroups[age].total++
        ageGroups[age].genders[gender] = (ageGroups[age].genders[gender] || 0) + 1
      })

      // Calculate overall stats
      const total = filtered.length
      const genderCounts = {}
      filtered.forEach(r => {
        const gender = r[COL_GENDER]
        if (gender) genderCounts[gender] = (genderCounts[gender] || 0) + 1
      })

      // Sort age groups by total count
      const sortedAges = Object.entries(ageGroups).sort((a, b) => b[1].total - a[1].total)
      const maxCount = Math.max(...sortedAges.map(([_, data]) => data.total), 1)

      container.innerHTML = `
        <div class="bg-white rounded-3xl shadow-lg p-8 mb-6">
          <div class="text-center mb-6">
            <div class="text-6xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-2">
              ${total}
            </div>
            <p class="text-gray-600 text-lg font-medium">people going</p>
          </div>

          <!-- Gender Summary -->
          <div class="flex justify-center gap-4 mb-8 flex-wrap">
            ${Object.entries(genderCounts).map(([gender, count]) => {
              const color = getGenderColor(gender)
              const icon = getGenderIcon(gender)
              return `
                <div class="flex items-center gap-2 bg-gray-50 rounded-full px-4 py-2">
                  <span class="text-xl">${icon}</span>
                  <span class="font-medium text-gray-700">${gender}</span>
                  <span class="text-sm rounded-full px-2 py-0.5 text-white" style="background: ${color.solid}">${count}</span>
                </div>
              `
            }).join('')}
          </div>

          <!-- Age Group Breakdown -->
          <div class="space-y-5">
            <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-4">Breakdown by Age Group</h3>
            ${sortedAges.map(([age, data]) => {
              const percentage = ((data.total / total) * 100).toFixed(0)
              const barWidth = (data.total / maxCount) * 100

              // Calculate gender percentages within this age group
              const genderSegments = Object.entries(data.genders).map(([gender, count]) => ({
                gender,
                count,
                percentage: (count / data.total) * 100
              }))

              return `
                <div class="chart-bar">
                  <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-3">
                      <span class="font-bold text-gray-900 text-xl">${age}</span>
                      <div class="flex gap-2">
                        ${genderSegments.map(({ gender, count }) => {
                          const icon = getGenderIcon(gender)
                          return `<span class="text-sm text-gray-600" title="${gender}: ${count}">${icon} ${count}</span>`
                        }).join(' ')}
                      </div>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-sm text-gray-500">${percentage}%</span>
                      <span class="font-bold text-gray-900 bg-gray-100 rounded-full px-3 py-1 min-w-[2.5rem] text-center">${data.total}</span>
                    </div>
                  </div>
                  <div class="h-16 bg-gray-100 rounded-xl overflow-hidden flex shadow-inner">
                    ${genderSegments.map(({ gender, percentage: genderPct }) => {
                      const color = getGenderColor(gender)
                      return `
                        <div class="h-full flex items-center justify-center text-white font-medium text-sm transition-all duration-500 hover:opacity-90"
                             style="width: ${genderPct}%; background: ${color.gradient};"
                             title="${gender}: ${genderPct.toFixed(0)}%">
                        </div>
                      `
                    }).join('')}
                  </div>
                </div>
              `
            }).join('')}
          </div>
        </div>
      `
    }

    document.getElementById('bar-select').addEventListener('change', renderChart)
    loadData()
    
    // Auto-refresh every 10 seconds
    setInterval(loadData, 10000)
  </script>
</body>
</html>